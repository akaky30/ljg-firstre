好 — 我把 **项目“Mobile Traffic Inspector”最开始要做的所有步骤** 按时间顺序、一步步拆细到能直接照做的程度：从环境准备、工具安装、网络与证书配置、到把 mitmproxy 插件 + Flask 后端跑起来并做一次最小验证（手机/模拟器访问 httpbin），以及 Frida 的基本准备。每一步都给出详尽命令、常见问题排查要点与备选方案（例如设备是否已 root / 使用模拟器等）。按着做完这些，你就完成了能做现场 Demo 的最核心前置工作。

# 先看一下目标（MVP 初始目标）

1. 在电脑上启动 Flask（接收会话）和 mitmproxy（拦截并把会话 POST 到 Flask）。
2. 手机/模拟器把流量走到电脑代理，并能通过代理访问 https://httpbin.org/get（验证 HTTPS 解密）。
3. mitmproxy 控制台显示会话并把会话发送到 Flask；Flask 能在 `/api/sessions` 接收到并保存。
4. （可选）配置 Frida 环境，准备好在后续步骤注入脚本观察中间值。

------

# 1) 环境准备（电脑端）

建议在一个 Python 虚拟环境里做所有开发（避免全局污染）。

Linux / macOS：

```
# （可选）创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 安装必要包
pip install mitmproxy flask requests frida-tools
```

Windows (PowerShell)：

```
python -m venv venv
.\venv\Scripts\Activate.ps1

pip install mitmproxy flask requests frida-tools
```

说明：

- `mitmproxy`：代理与抓包。
- `flask`、`requests`：后端与 mitmproxy → 后端 的 POST（mitm脚本里会用 requests）。
- `frida-tools`：提供 `frida` CLI（后续进行动态 Hook 时用到）。
   若 pip 安装报错，确认 Python 版本 >= 3.8 并更新 pip：`python -m pip install -U pip setuptools wheel`。

------

# 2) 查找并记录电脑的局域网 IP

要把手机代理指向电脑 IP，先查出电脑局域网 IP：

Linux / macOS：

```
ip addr show            # 或者: ifconfig
# 寻找 wifi/eth0 下的 IPv4 地址，比如 192.168.1.123
```

Windows (cmd 或 PowerShell)：

```
ipconfig
# 找到 Wireless LAN adapter 或 Ethernet adapter 下的 IPv4 地址
```

把这个 IP 记下来，后面 mitmproxy 和 Flask 的地址都要用到（示例：`192.168.1.123`）。

------

# 3) 启动 Flask 后端（最小版，用于接收会话）

在项目目录新建 `app.py`，把下面的最小代码放进去（文件完整、可直接运行）：

```
# app.py
from flask import Flask, request, jsonify, send_file
import sqlite3, os, uuid, json

DB = "sessions.db"
os.makedirs("frida_out", exist_ok=True)
app = Flask(__name__)

def init_db():
    conn = sqlite3.connect(DB)
    conn.execute("""CREATE TABLE IF NOT EXISTS sessions(
        id TEXT PRIMARY KEY, time TEXT, url TEXT, method TEXT, headers TEXT, body TEXT, suspicious TEXT
    )"""); conn.commit(); conn.close()
init_db()

@app.route("/api/sessions", methods=["POST"])
def add_session():
    j = request.get_json()
    sid = str(uuid.uuid4())
    conn = sqlite3.connect(DB)
    conn.execute("INSERT INTO sessions VALUES(?,?,?,?,?,?,?)",
                 (sid, j.get("time"), j.get("url"), j.get("method"),
                  json.dumps(j.get("headers")), j.get("body"), json.dumps(j.get("suspicious"))))
    conn.commit(); conn.close()
    return jsonify({"id": sid}), 201

@app.route("/api/sessions", methods=["GET"])
def list_sessions():
    conn = sqlite3.connect(DB)
    rows = conn.execute("SELECT id,time,url,method,suspicious FROM sessions ORDER BY time DESC LIMIT 200").fetchall()
    conn.close()
    out = [{"id":r[0],"time":r[1],"url":r[2],"method":r[3],"suspicious":json.loads(r[4])} for r in rows]
    return jsonify(out)

@app.route("/api/sessions/<sid>", methods=["GET"])
def get_session(sid):
    conn = sqlite3.connect(DB)
    row = conn.execute("SELECT * FROM sessions WHERE id=?", (sid,)).fetchone()
    conn.close()
    if not row: return jsonify({"error":"not found"}),404
    return jsonify({"id":row[0],"time":row[1],"url":row[2],"method":row[3],
                    "headers":json.loads(row[4]),"body":row[5],"suspicious":json.loads(row[6])})

if __name__ == "__main__":
    # 绑定到 0.0.0.0 以便局域网设备访问
    app.run(host="0.0.0.0", port=5000, debug=True)
```

运行：

```
python app.py
```

在浏览器访问 `http://<你的电脑IP>:5000/api/sessions` 应该返回空数组 `[]`（或没有错误）。如果浏览器报无法连接，检查防火墙是否阻挡 5000 端口（必要时允许该端口）。

------

# 4) 准备 mitmproxy addon（把会话 POST 到 Flask）

新建 `mitm_to_flask.py`（这是之前示例的改良版，直接把会话异步发到 Flask）：

```
# mitm_to_flask.py
from mitmproxy import http
import re, json, base64, threading, requests
from datetime import datetime

API_URL = "http://<你的电脑IP>:5000/api/sessions"  # <- 把这里替换为你的电脑 IP

def looks_like_base64(s: str):
    s = s.strip()
    if len(s) % 4 != 0 or len(s) < 8:
        return False
    try:
        return base64.b64encode(base64.b64decode(s)) == s.encode()
    except Exception:
        return False

def detect_sensitive_from_text(text: str):
    import math, collections
    hits = []
    if not text:
        return hits
    if re.search(r"\b1[3-9]\d{9}\b", text):
        hits.append(("phone", "match"))
    if re.search(r"[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}", text):
        hits.append(("email", "match"))
    tokens = re.findall(r"[A-Za-z0-9+/=]{8,}", text)
    for t in tokens:
        if looks_like_base64(t):
            hits.append(("base64", t))
    return hits

def async_post(payload):
    try:
        requests.post(API_URL, json=payload, timeout=3)
    except Exception as e:
        print("[mitm->flask] post error:", e)

def request(flow: http.HTTPFlow) -> None:
    try:
        body = flow.request.get_text(strict=False)
    except Exception:
        body = ""
    data = {
        "time": datetime.utcnow().isoformat() + "Z",
        "client": str(flow.client_conn.address),
        "method": flow.request.method,
        "url": flow.request.url,
        "headers": dict(flow.request.headers),
        "body": body,
    }
    data["suspicious"] = detect_sensitive_from_text(body + " " + json.dumps(data["headers"]))
    threading.Thread(target=async_post, args=(data,), daemon=True).start()
    if data["suspicious"]:
        print("[SUSP] ", data["method"], data["url"], data["suspicious"])
    else:
        print("[OK] ", data["method"], data["url"])
```

运行 mitmproxy（在同一目录）：

```
mitmproxy -s mitm_to_flask.py --listen-port 8080
```

注意：

- `API_URL` 必须是 `http://<你的电脑IP>:5000/api/sessions`，不能用 `localhost`，因为 mitmproxy 的进程可能与手机处于不同的网络上下文，手机要能访问该 IP。
- `--listen-port 8080` 为示例端口，你可以更换，但使用默认 8080 常见。

------

# 5) 在手机/模拟器上设置代理 & 安装 mitmproxy 证书（HTTPS 解密）

## A. 手机在同一 Wi-Fi 下设置代理

在手机 Wi-Fi 网络详细设置里，把 HTTP 代理设为 `手动`，主机名填电脑 IP，端口填 mitmproxy 监听端口（默认 8080）。

## B. 安装 mitmproxy 根证书（方便 HTTPS 解密）

1. 确保 mitmproxy 正在运行。
2. 手机浏览器访问 `http://mitm.it`（在手机通过代理访问时，mitmproxy 会返回证书页面）。
3. 选择 Android/iOS 并下载证书并安装。
   - Android：下载后按提示安装为“用户证书”。
   - 注意：Android 7+（API >= 24）默认不信任用户证书用于应用 HTTPS。如果目标 App 使用 `Network Security Config` 或直接 pin 证书，用户 CA 也可能无效。此时有两种办法：
     - 使用 **模拟器**（Android Emulator）并在镜像上将证书安装为 system CA（模拟器更容易做证书为 system）。
     - 或者使用 **root 设备**，把证书放到系统 CA（`/system/etc/security/cacerts`）并重启。
     - 或者在靶场 APK 中允许用户 CA（在学习/靶场场景下可行）。

> 小贴士：测试阶段强烈推荐用 Android 模拟器（Android Emulator）或已 root 的测试设备，这样 HTTPS 解密会更顺利。

------

# 6) 验证代理是否有效（最小验证）

在手机浏览器访问 `https://httpbin.org/get`：

- 如果一切正确，mitmproxy 控制台会打印类似：

  ```
  [OK] GET https://httpbin.org/get
  ```

- Flask 应该收到 POST 并在 `/api/sessions` 出现一条记录。你可以在电脑浏览器访问：

  ```
  http://<你的电脑IP>:5000/api/sessions
  ```

  应看到类似 `[{"id":"...","time":"...","url":"https://httpbin.org/get", ...}]` 的 JSON。

如果失败，参考“常见问题排查”部分。

------

# 7) Frida 基础准备（方便后面做动态 Hook）

Frida 分两端：电脑端 CLI（已通过 `pip install frida-tools` 安装），以及设备端 `frida-server`（需放到设备并运行）。

## 获取 frida-server

1. 在电脑上查看 `frida --version` 确认安装成功。
2. 在 Frida releases 页面（本地你可以去 frida.releases 或 Github）下载与你手机 Android 版本和 CPU 架构匹配的 `frida-server` 二进制（比如 `frida-server-15.x.x-android-arm64.xz`）。
   - 如果你没法下载（无网络或其它原因），可以先在模拟器上跳过这步，后面我可以给替代方案（Frida Gadget 或 instrumented APK）。
3. 将二进制推到设备并运行（需要 adb）：

```
adb push frida-server /data/local/tmp/
adb shell "chmod 755 /data/local/tmp/frida-server"
# 如果设备已 root:
adb shell "su -c /data/local/tmp/frida-server &"
# 或者直接（部分模拟器不需 root）:
adb shell "/data/local/tmp/frida-server &"
```

1. 在电脑上用 `frida-ps -U` 查看设备上的进程列表，确认 frida-server 可连接。

**注意**：frida-server 大多数情况下需要在设备上以 root 权限运行才能成功做注入（尤其是系统 app 或普通 app）。常用做法：使用模拟器或已 root 的测试手机，或者改用 Frida Gadget（把 frida 集成到待测 APK）。

------

# 8) 常见问题与排查（遇到问题优先看这里）

- **手机不能访问 `http://<电脑IP>:5000`**
  - 检查手机和电脑是否在同一子网；关闭 VPN。
  - 检查防火墙（Windows Defender / ufw）是否阻止 5000/8080 端口；临时允许或关闭防火墙测试。
- **mitmproxy 启动后手机无法连网 / 访问超时**
  - 确认代理 IP/端口设置正确。
  - 确认 mitmproxy 正在监听正确接口（默认监听所有接口，若只监听 loopback 则无法被手机访问）。若需要监听特定接口可 `mitmproxy --listen-host 0.0.0.0 -p 8080`。
- **HTTPS 无法解密（证书相关）**
  - 访问 `http://mitm.it`，重新安装证书。
  - 如果 App 明确做了证书 pin 或 Android 7+ 拒用户 CA：用模拟器或 root 设备，或修改 APK。
- **mitmproxy 插件发 POST 到 Flask 报错**
  - 在 mitm 脚本里 `API_URL` 必须用电脑局域网 IP（不能用 localhost）。
  - mitmproxy 线程里使用 requests 时可能因环境问题找不到证书，若需要可设置 `verify=False`（仅测试用）。
- **frida 连接不到设备或 frida-ps 报错**
  - 确认 frida-server 正在设备上运行并有执行权限。部分设备需要 `adb root` 或 root 权限才能运行 frida-server。
  - 检查 frida-server 版本是否与 frida-tools 兼容（版本号接近）。

------

# 9) 最小验证用例（把流程串通起来）

1. 启动 Flask：`python app.py` → 确保 `http://<IP>:5000/api/sessions` 可访问。
2. 启动 mitmproxy：`mitmproxy -s mitm_to_flask.py --listen-port 8080`。在控制台确认没有异常。
3. 手机设置代理到 `http://<IP>:8080`，在手机浏览器打开 `http://mitm.it` 安装证书。
4. 手机浏览器打开 `https://httpbin.org/get`。
5. 在 mitmproxy 控制台应看到一条 GET 记录，Flask 接收并存储；在浏览器访问 Flask 的 `/api/sessions`，能看到对应记录。成功！

------

# 10) 小结清单（Checklist，逐项打勾即可）

-  在电脑创建 Python venv 并安装 `mitmproxy, flask, requests, frida-tools`
-  记录电脑局域网 IP（例如 `192.168.1.123`）
-  启动 Flask（`python app.py`），并测试 `http://<IP>:5000/api/sessions` 返回正常
-  放好 `mitm_to_flask.py`，并在脚本中把 `API_URL` 改为 `http://<IP>:5000/api/sessions`
-  启动 mitmproxy：`mitmproxy -s mitm_to_flask.py -p 8080`
-  手机/模拟器 Wi-Fi 指向电脑 IP:8080（并安装 mitmproxy 证书）
-  在手机上访问 `https://httpbin.org/get`，确认 mitmproxy 与 Flask 均收到会话
-  如果需要 Frida：下载并在设备上运行 frida-server，确认 `frida-ps -U` 可列进程