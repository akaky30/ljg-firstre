<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MITM 会话可视化 (WebSocket + Memory Dump + Probe)</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
  /* 全局微调 */
  body { background: #f5f7fb; color: #222; }
  h4 { letter-spacing: .2px; }
  /* 卡片与表格 */
  .card { box-shadow: 0 6px 18px rgba(20,30,50,0.06); border: 0; }
  .table tbody tr { cursor: pointer; }
  .suspicious { display:inline-block; margin-right:6px; }
  .badge-susp { background: linear-gradient(90deg,#ff6b6b,#ff8a80); color:#fff; font-weight:600; padding:0.25rem 0.45rem; border-radius:0.35rem; font-size:0.82rem; }
  .badge-info-field { background:#e7f3ff; color:#0b62a4; border:1px solid rgba(11,98,164,0.08); padding:0.25rem 0.45rem; border-radius:0.35rem; }

  /* 控制台（放大优化） */
  #consoleOutput {
    background: #0b0f12;
    color: #9cff9c;
    height: 360px;               /* 默认更大 */
    overflow:auto;
    padding: 12px;
    border-radius:6px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Cascadia Mono", "Segoe UI Mono", "Roboto Mono", monospace;
    font-size: 12px;
    line-height: 1.4;
    white-space: pre-wrap;
    word-break: break-word;
    resize: vertical;            /* 允许拖动改变高度 */
    min-height: 160px;
    transition: height .18s ease-in-out;
  }
  .console-controls .btn { min-width: 40px; }
  .toolbar-btn { min-width: 44px; }
  .muted-small { font-size: 0.85rem; color:#6c757d; }
  .action-col { width:140px; }
  .session-row:hover { background:#f1f7ff; }

  /* 右侧 detail 区 */
  .detail-card { max-height: 88vh; overflow:auto; padding-bottom:8px; }
  .label-strong { font-weight:600; }
  .banner-error { background:#ffe3e3; border:1px solid #ffbcbc; padding:8px 12px; border-radius:6px; color:#8a1f1f; margin-bottom:10px; }

  /* 详情中长文本滚动 */
  pre#detailHeaders, pre#detailBody {
    background: #f8f9fa;
    border-radius:6px;
    padding:10px;
    max-height:160px;
    overflow:auto;
    white-space: pre-wrap;
    word-break: break-word;
  }

  /* 自定义脚本文本域（更高并可缩放） */
  #customScript { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, monospace; font-size:13px; background:#fff; resize: vertical; min-height:160px; }

  /* 左侧列表自适应高度 */
  #leftListWrapper { max-height:88vh; overflow:auto; }

  /* 小屏适配 */
  @media (max-width: 900px) {
    #consoleOutput { height: 220px; }
    .action-col { width:120px; }
    pre#detailHeaders, pre#detailBody { max-height:120px; }
  }

  /* 控制台展开样式 */
  .expanded-console { height: calc(95vh - 130px) !important; z-index: 1050; box-shadow: 0 10px 40px rgba(0,0,0,0.35); }

  /* custom script textarea */
  #customScript { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, monospace; font-size:13px; background:#fff; }
</style>
</head>
<body>
<div class="container-fluid mt-3">
  <div class="d-flex align-items-center mb-3">
    <h4 class="me-3 mb-0">MITM 会话可视化</h4>
    <small class="text-muted">实时会话、Frida 模板与 Probe 支持</small>
  </div>

  <div id="debugBanner" style="display:none;" class="banner-error"></div>

  <div class="row g-3">
    <!-- 左侧：列表 -->
    <div class="col-lg-6">
      <div class="card p-3">
        <div class="d-flex mb-2 align-items-center">
          <input id="searchInput" class="form-control me-2" placeholder="搜索 URL / 方法 / body (按 Enter)">
          <div class="btn-group" role="group" aria-label="export">
            <button id="exportJsonBtn" class="btn btn-outline-secondary toolbar-btn" title="导出 JSON"><i class="bi bi-file-earmark-code"></i></button>
            <button id="exportCsvBtn" class="btn btn-outline-secondary toolbar-btn" title="导出 CSV"><i class="bi bi-file-earmark-spreadsheet"></i></button>
            <button id="clearSessionsBtn" class="btn btn-outline-danger toolbar-btn" title="清空所有会话"><i class="bi bi-trash"></i></button>
          </div>
          <div class="ms-3 ms-md-auto text-end">
            <span id="statusInfo" class="muted-small">会话总数: —</span>
            <span id="socketStatus" class="ms-2 muted-small" style="font-style:italic;">socket: —</span>
          </div>
        </div>

        <div id="leftListWrapper" class="table-responsive" style="max-height:64vh; overflow:auto;">
          <table class="table table-sm align-middle mb-0" id="sessionTable">
            <thead class="table-light sticky-top" style="top:0;">
              <tr>
                <th style="width:140px">时间</th>
                <th>URL</th>
                <th style="width:80px">方法</th>
                <th style="width:160px">敏感字段</th>
                <th class="text-center action-col">操作</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div id="emptyListNote" class="text-center text-muted p-3" style="display:none;">当前没有会话，确认 mitmproxy 已将数据上报到后端。</div>
        </div>

        <div class="mt-2">
          <small class="text-muted">点击“查看”可在右侧显示会话详情与 Frida 操作。</small>
        </div>
      </div>
    </div>

    <!-- 右侧：详情 / 模板 / 控制台 -->
    <div class="col-lg-6">
      <div class="card detail-card p-3">
        <div class="d-flex align-items-center mb-2">
          <h5 class="mb-0 me-2">会话详情</h5>
          <div class="ms-auto">
            <button id="generateFridaBtn" class="btn btn-outline-primary btn-sm me-1" title="生成并下载当前会话的 Frida 脚本"><i class="bi bi-download"></i> 脚本</button>
            <button id="runFridaBtn" class="btn btn-success btn-sm me-1" title="为当前会话生成脚本并运行 Frida"><i class="bi bi-play-fill"></i> 运行</button>
            <label class="form-check-label ms-1"><input type="checkbox" id="spawnCheckbox" class="form-check-input me-1">Spawn</label>
          </div>
        </div>

        <ul class="nav nav-tabs mb-3" id="rightTabs" role="tablist">
          <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-detail">详情 & 模板</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-custom">自定义脚本</a></li>
        </ul>

        <div class="tab-content">
          <div class="tab-pane fade show active" id="tab-detail">
            <div id="sessionDetail" style="display:none;">
              <div class="mb-1"><span class="label-strong">URL:</span> <span id="detailUrl" class="text-break"></span></div>
              <div class="mb-1"><span class="label-strong">方法:</span> <span id="detailMethod"></span></div>

              <div class="mb-2">
                <div class="label-strong">Headers:</div>
                <pre id="detailHeaders" class="mb-1"></pre>
              </div>

              <div class="mb-2">
                <div class="label-strong">Body:</div>
                <pre id="detailBody" class="mb-1"></pre>
              </div>

              <hr>

              <div class="mb-2">
                <h6 class="mb-2">Memory / Frida Templates</h6>
                <div class="row g-2 align-items-center">
                  <div class="col-md-7">
                    <select id="memTemplate" class="form-select">
                      <option value="dump_class_string_fields">Dump class string fields（需类名）</option>
                      <option value="search_jwt_in_static_strings">Search JWT in static strings</option>
                      <option value="ssl_pinning_bypass">SSL Pinning Bypass</option>
                      <option value="sharedprefs_dump">Dump SharedPreferences</option>
                    </select>
                  </div>
                  <div class="col-md-5">
                    <input id="memClassInput" class="form-control" placeholder="类名（dump_class_string_fields 需要）">
                  </div>
                  <div class="col-12 text-end">
                    <button id="runMemBtn" class="btn btn-primary btn-sm mt-2"><i class="bi bi-lightning-fill"></i> 执行模板</button>
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <h6 class="mb-2">Probe (查找进程/类名)</h6>
                <div class="d-flex g-2">
                  <input id="probeAppInput" class="form-control me-2" placeholder="Probe 目标包名（例如 com.example.app）">
                  <input id="probeTimeout" class="form-control me-2" style="width:110px" placeholder="秒数" value="4">
                  <button id="runProbeBtn" class="btn btn-warning"><i class="bi bi-search"></i> 运行 Probe</button>
                </div>
                <div class="mt-1"><small class="text-muted">注意：Probe 和 Frida 操作可能需要管理员 token（如已启用）。</small></div>
              </div>
            </div>

            <div id="noSelection" class="text-center text-muted" style="padding:28px;">
              <i class="bi bi-info-circle me-2"></i> 请在左侧选择一个会话以查看详情与 Frida 操作
            </div>
          </div>

          <!-- 自定义脚本 Tab -->
          <div class="tab-pane fade" id="tab-custom">
            <h6 class="mb-2">自定义 Frida 脚本</h6>
            <textarea id="customScript" class="form-control mb-2" rows="18" placeholder="在这里输入 Frida JavaScript 代码..."></textarea>
            <input id="customAppInput" class="form-control mb-2" placeholder="目标 App 包名，例如 com.example.app">
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="customSpawn">
              <label class="form-check-label" for="customSpawn">Spawn 模式</label>
            </div>
            <div class="d-flex gap-2">
              <button id="runCustomBtn" class="btn btn-success"><i class="bi bi-play-fill"></i> 注入脚本</button>
              <button id="fillExampleBtn" class="btn btn-outline-secondary">填充示例脚本</button>
            </div>
            <div class="mt-2 text-muted"><small>注：请确保已在设备/模拟器上启动 frida-server，且主机 frida 版本匹配。</small></div>
          </div>
        </div>

        <hr>

        <div class="d-flex justify-content-between align-items-center mb-2">
          <div><label class="label-strong">控制台输出（Frida / 后端 / Probe）</label></div>
          <div class="console-controls">
            <button id="clearConsoleBtn" class="btn btn-sm btn-outline-secondary me-1" title="清空控制台"><i class="bi bi-x-circle"></i></button>
            <button id="copyConsoleBtn" class="btn btn-sm btn-outline-secondary me-1" title="复制控制台全部内容"><i class="bi bi-clipboard"></i></button>
            <button id="toggleConsoleSizeBtn" class="btn btn-sm btn-outline-secondary" title="放大/还原 控制台"><i class="bi bi-arrows-fullscreen"></i></button>
          </div>
        </div>
        <pre id="consoleOutput" role="log" aria-live="polite"></pre>
      </div>
    </div>
  </div>
</div>

<script>
/*
  动态构造 API_BASE：使用当前页面 origin + /api
*/
const API_BASE = `${location.protocol}//${location.host}/api`;
const POLL_INTERVAL = 5000; // 毫秒：轮询间隔（用于在 socket 丢失时仍能刷新）
let currentId = null;
const socket = io(); // 使用默认 connect 到同 origin 的 socket.io

// small helpers for UI
function showDebugBanner(msg) {
  const b = document.getElementById('debugBanner');
  if (!msg) { b.style.display='none'; b.innerText=''; return; }
  b.style.display='block'; b.innerText = msg;
}

function setSocketStatus(s) {
  try { document.getElementById('socketStatus').innerText = 'socket: ' + s; } catch(e) {}
}

// socket events
socket.on("connect", ()=> {
    appendConsole("[socket] connected");
    setSocketStatus("connected");
    showDebugBanner("");
    loadSessions(document.getElementById("searchInput").value.trim());
});
socket.on("connect_error", (err) => {
    appendConsole("[socket] connect_error: " + err);
    setSocketStatus("connect_error");
    showDebugBanner("WebSocket 连接失败，界面将通过轮询更新。请检查后端 socket 支持 (Flask-SocketIO)。");
});
socket.on("disconnect", (reason) => {
    appendConsole("[socket] disconnected: " + reason);
    setSocketStatus("disconnected");
    showDebugBanner("WebSocket 已断开，界面将通过轮询更新。");
});
socket.on("session_new", data => {
    appendConsole("[socket] session_new: " + (data && data.id ? data.id : JSON.stringify(data)));
    // 新会话到达后立即刷新列表
    loadSessions(document.getElementById("searchInput").value.trim());
});
socket.on("sessions_cleared", ()=> {
    document.querySelector("#sessionTable tbody").innerHTML = "";
    document.getElementById("sessionDetail").style.display = "none";
    document.getElementById("noSelection").style.display = "block";
    document.getElementById("statusInfo").textContent = "会话总数: 0";
    appendConsole("[socket] sessions_cleared");
});
socket.on("frida_log", msg => appendConsole(msg.line || JSON.stringify(msg)));
socket.on("frida_started", info => appendConsole("[frida_started] pid=" + info.pid + " script=" + info.script));

// load sessions and fill table
async function loadSessions(q="") {
    try {
        const url = q ? `${API_BASE}/sessions?q=${encodeURIComponent(q)}` : `${API_BASE}/sessions`;
        const res = await fetch(url, {cache: "no-store"});
        if (!res.ok) {
            appendConsole("[loadSessions] · HTTP " + res.status + " " + res.statusText + " for " + url);
            if (res.status === 404) {
                showDebugBanner(`接口未找到 (404): ${url}。请确认后端在此地址提供 /api/sessions（查看 app.py 中路由）。`);
            } else {
                showDebugBanner(`从后端获取会话失败: HTTP ${res.status}`);
            }
            document.getElementById("statusInfo").textContent = "会话总数: —";
            document.getElementById("emptyListNote").style.display = "block";
            return;
        }
        showDebugBanner("");
        const sessions = await res.json();
        const tbody = document.querySelector("#sessionTable tbody");
        tbody.innerHTML = "";
        if (!Array.isArray(sessions) || sessions.length === 0) {
            document.getElementById("emptyListNote").style.display = "block";
        } else {
            document.getElementById("emptyListNote").style.display = "none";
        }
        sessions.forEach(s => {
            const tr = document.createElement("tr");
            tr.className = "session-row";
            tr.innerHTML = `
                <td style="width:140px">${escapeHtml(s.time)}</td>
                <td style="max-width:520px; overflow:hidden; text-overflow:ellipsis;" title="${escapeHtml(s.url)}">${escapeHtml(s.url)}</td>
                <td style="width:80px">${escapeHtml(s.method)}</td>
                <td>${(s.suspicious||[]).map(f=>`<span class="badge-susp suspicious" title="${escapeHtml(f)}">${escapeHtml(shortSusp(f))}</span>`).join(' ')}</td>
                <td class="text-center action-col"><button class="btn btn-sm btn-info" onclick="viewDetail('${s.id}')"><i class="bi bi-eye"></i> 查看</button></td>
            `;
            tbody.appendChild(tr);
        });
        // update session count
        document.getElementById("statusInfo").textContent = "会话总数: " + (Array.isArray(sessions) ? sessions.length : 0);
    } catch (e) {
        appendConsole("[loadSessions] error: " + e);
        showDebugBanner("获取会话遇到异常（请检查后端是否可达）：" + e);
    }
}

function shortSusp(s) {
    if (typeof s !== 'string') return s;
    return s.length > 18 ? s.slice(0,15) + '...' : s;
}

function escapeHtml(s) {
    if (!s && s !== 0) return "";
    return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
}

// search input Enter
document.getElementById("searchInput").addEventListener("keydown", (e) => {
    if (e.key === "Enter") loadSessions(e.target.value.trim());
});
document.getElementById("exportJsonBtn").onclick = ()=> window.location.href = `${API_BASE}/sessions/export?format=json`;
document.getElementById("exportCsvBtn").onclick = ()=> window.location.href = `${API_BASE}/sessions/export?format=csv`;

// clear sessions
document.getElementById("clearSessionsBtn").onclick = async () => {
    if (!confirm("确定要清空所有会话吗？此操作不可恢复。")) return;
    const token = prompt("如果已设置 ADMIN_TOKEN，请输入（直接回车则空）:");
    const headers = token ? {"X-ADMIN-TOKEN": token} : {};
    try {
        const r = await fetch(`${API_BASE}/clear_sessions`, { method:"POST", headers });
        const j = await r.json().catch(()=> ({}));
        if (r.status === 200 && j.status === "ok") {
            alert("已清空");
            loadSessions();
        } else {
            alert("清空失败: " + JSON.stringify(j));
            appendConsole("[clear_sessions] failed: " + JSON.stringify(j));
        }
    } catch (e) {
        appendConsole("[clear_sessions] error: " + e);
        alert("清空遇到错误: " + e);
    }
};

// view detail
async function viewDetail(id) {
    try {
        currentId = id;
        const res = await fetch(`${API_BASE}/sessions/${id}`);
        if (!res.ok) { appendConsole("[viewDetail] fetch error: " + res.status); return; }
        const session = await res.json();
        document.getElementById("detailUrl").innerText = session.url;
        document.getElementById("detailMethod").innerText = session.method;
        document.getElementById("detailHeaders").innerText = JSON.stringify(session.headers || {}, null, 2);
        document.getElementById("detailBody").innerText = session.body || "";
        document.getElementById("sessionDetail").style.display = "block";
        document.getElementById("noSelection").style.display = "none";
        // 清空控制台以便观察当前会话输出
        document.getElementById("consoleOutput").textContent = "";
        // 自动切换到详情 tab（若不在）
        const tabEl = document.querySelector('#rightTabs a[href="#tab-detail"]');
        if (tabEl) new bootstrap.Tab(tabEl).show();
    } catch (e) {
        appendConsole("[viewDetail] error: " + e);
    }
}

// generate frida
document.getElementById("generateFridaBtn").onclick = async () => {
    if (!currentId) return alert("先选择一个会话");
    try {
        const r = await fetch(`${API_BASE}/generate_frida`, { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({id:currentId})});
        if (r.status === 200) {
            const script = await r.text();
            const blob = new Blob([script], {type:"text/javascript"});
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `frida_${currentId}.js`; a.click();
            URL.revokeObjectURL(a.href);
        } else {
            const txt = await r.text().catch(()=>"");
            alert("生成失败: " + r.status + " " + txt);
        }
    } catch (e) {
        appendConsole("[generateFrida] error: " + e);
        alert("生成失败: " + e);
    }
};

// run frida (use templates / session)
document.getElementById("runFridaBtn").onclick = async () => {
    if (!currentId) return alert("先选择一个会话");
    const appName = prompt("请输入目标 App 包名（例如 com.example.app）:");
    if (!appName) return;
    const spawn = document.getElementById("spawnCheckbox").checked;
    const token = prompt("如果已设置 ADMIN_TOKEN，请输入（直接回车则空）:");
    const headers = {"Content-Type":"application/json"};
    if (token) headers["X-ADMIN-TOKEN"] = token;
    appendConsole("[run_frida] 请求注入: " + appName);
    try {
        const r = await fetch(`${API_BASE}/run_frida`, {
            method:"POST", headers, body: JSON.stringify({id: currentId, app: appName, spawn: spawn})
        });
        const j = await r.json().catch(()=>({}));
        if (r.status === 200 && j.status === "ok") {
            appendConsole("[run_frida] started pid=" + j.pid);
        } else {
            appendConsole("[run_frida] error: " + JSON.stringify(j));
            alert("运行失败: " + JSON.stringify(j));
        }
    } catch (e) {
        appendConsole("[run_frida] exception: " + e);
        alert("运行失败: " + e);
    }
};

// run mem template
document.getElementById("runMemBtn").onclick = async () => {
    const tpl = document.getElementById("memTemplate").value;
    const cls = document.getElementById("memClassInput").value.trim();
    const appName = prompt("请输入目标 App 包名（例如 com.example.app）:");
    if (!appName) return;
    const token = prompt("如果已设置 ADMIN_TOKEN，请输入（直接回车则空）:");
    const headers = {"Content-Type":"application/json"};
    if (token) headers["X-ADMIN-TOKEN"] = token;

    const body = { app: appName, spawn:false, template: tpl, template_params: {} };
    if (tpl === "dump_class_string_fields") {
        if (!cls) return alert("请填写类名，例如 com.example.app.LoginManager");
        body.template_params = { class_name: cls };
    }

    try {
        const r = await fetch(`${API_BASE}/run_frida`, { method:"POST", headers, body: JSON.stringify(body) });
        const j = await r.json().catch(()=>({}));
        if (r.status===200 && j.status==="ok") {
            appendConsole("[run_template] started pid=" + j.pid);
        } else {
            appendConsole("[run_template] error: " + JSON.stringify(j));
            alert("运行失败: " + JSON.stringify(j));
        }
    } catch (e) {
        appendConsole("[run_template] exception: " + e);
        alert("运行失败: " + e);
    }
};

// probe runner
document.getElementById("runProbeBtn").onclick = async () => {
    const appName = document.getElementById("probeAppInput").value.trim() || prompt("请输入 Probe 目标包名：");
    if (!appName) return;
    const timeout = parseFloat(document.getElementById("probeTimeout").value || "4");
    const token = prompt("如果已设置 ADMIN_TOKEN，请输入（直接回车则空）:");
    const headers = {"Content-Type":"application/json"};
    if (token) headers["X-ADMIN-TOKEN"] = token;
    appendConsole("[probe] start for " + appName);
    try {
        const r = await fetch(`${API_BASE}/probe`, { method:"POST", headers, body: JSON.stringify({ app: appName, timeout: timeout })});
        const j = await r.json().catch(()=>null);
        if (r.status === 200 && j) {
            if (j.matches && Array.isArray(j.matches) && j.matches.length) {
                appendConsole("[probe matches]\n" + j.matches.join("\n"));
            } else if (j.found !== undefined) {
                appendConsole("[probe] found=" + j.found + " raw_count=" + (j.raw_count || 0));
            } else if (j.stdout) {
                if (j.stdout) appendConsole("[probe stdout]\n" + j.stdout);
                if (j.stderr) appendConsole("[probe stderr]\n" + j.stderr);
            } else {
                appendConsole("[probe] 返回成功但无可显示字段: " + JSON.stringify(j));
            }
        } else {
            appendConsole("[probe] error: " + JSON.stringify(j || {}));
            alert("Probe 失败: " + (j ? JSON.stringify(j) : "unknown"));
        }
    } catch (e) {
        appendConsole("[probe] exception: " + e);
        alert("Probe 异常: " + e);
    }
};

// run custom script (独立接口调用)
document.getElementById("runCustomBtn").onclick = async () => {
    const script = document.getElementById("customScript").value.trim();
    const appName = document.getElementById("customAppInput").value.trim();
    const spawn = document.getElementById("customSpawn").checked;
    if (!script || !appName) return alert("请填写脚本和包名");
    const token = prompt("如果设置了 ADMIN_TOKEN，请输入（直接回车则空）:") || "";
    const headers = {"Content-Type":"application/json"};
    if (token) headers["X-ADMIN-TOKEN"] = token;
    appendConsole("[run_frida_custom] 请求注入: " + appName);
    try {
        const r = await fetch(`${API_BASE}/run_frida_custom`, {
            method:"POST", headers,
            body: JSON.stringify({ app: appName, script, spawn })
        });
        const j = await r.json().catch(()=>{});
        if (r.status===200 && j && j.status==="ok") {
            appendConsole("[run_frida_custom] started pid=" + j.pid);
        } else {
            appendConsole("[run_frida_custom] error: " + JSON.stringify(j));
            alert("注入失败: " + JSON.stringify(j));
        }
    } catch(e){ appendConsole("[run_frida_custom] exception: " + e); alert("注入异常: " + e); }
};

// 填充示例脚本
document.getElementById("fillExampleBtn").onclick = () => {
    const example = `// 示例：打印应用包名 + hook okhttp 请求
Java.perform(function(){
  try {
    console.log("[example] Java runtime OK");
    var OkHttpClient = Java.use('okhttp3.OkHttpClient');
    var Buffer = Java.use('okio.Buffer');
    var newCall = OkHttpClient.newCall.overload('okhttp3.Request');
    newCall.implementation = function(request){
      try {
        var url = "(unknown)";
        try { url = request.url().toString(); } catch(e){}
        console.log("[example][okhttp] " + url);
      } catch(e){}
      return newCall.call(this, request);
    };
  } catch(e){ console.log("[example] err", e); }
});`;
    document.getElementById("customScript").value = example;
};

// append console
function appendConsole(s) {
    try {
        const el = document.getElementById("consoleOutput");
        el.textContent += "[" + new Date().toLocaleTimeString() + "] " + s + "\n";
        el.scrollTop = el.scrollHeight;
        console.log(s);
    } catch (e) { console.log("appendConsole err:", e, s); }
}

function copyConsole() {
    try {
        const txt = document.getElementById("consoleOutput").textContent;
        navigator.clipboard?.writeText(txt).then(()=> appendConsole("[console copied]"), ()=> appendConsole("[console copy failed]"));
    } catch (e) { appendConsole("[copyConsole] error: " + e); }
}

// 控制台按钮绑定
document.getElementById('clearConsoleBtn').addEventListener('click', ()=> { document.getElementById('consoleOutput').textContent = ''; });
document.getElementById('copyConsoleBtn').addEventListener('click', copyConsole);

// 控制台放大/还原
const toggleConsoleBtn = document.getElementById('toggleConsoleSizeBtn');
toggleConsoleBtn.addEventListener('click', ()=> {
    const el = document.getElementById('consoleOutput');
    const icon = toggleConsoleBtn.querySelector('i');
    if (el.classList.contains('expanded-console')) {
        el.classList.remove('expanded-console');
        icon.className = 'bi bi-arrows-fullscreen';
        toggleConsoleBtn.title = '放大/还原 控制台';
    } else {
        el.classList.add('expanded-console');
        icon.className = 'bi bi-fullscreen-exit';
        toggleConsoleBtn.title = '还原 控制台';
        // 确保滚动到最底
        setTimeout(()=> el.scrollTop = el.scrollHeight, 50);
    }
});

// 双击控制台也可以放大/还原
document.getElementById('consoleOutput').addEventListener('dblclick', ()=> toggleConsoleBtn.click());

// 轮询以便在 websocket 不可用时仍能更新
setInterval(()=> {
    // only poll when socket is not connected
    if (!socket || socket.disconnected) {
        loadSessions(document.getElementById("searchInput").value.trim());
    }
}, POLL_INTERVAL);

// 初次加载
loadSessions();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
